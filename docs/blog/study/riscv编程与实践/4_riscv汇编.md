# riscv汇编

------

## RISC-V体系介绍

## RISC-V寄存器

### 通用寄存器

64位的RISC-V体系结构提供32个64位的整型通用寄存器，分别是x0-x31寄存器

32位的RISC-V体系结构提供32个32位的整型通用寄存器

对于浮点数运算，64位的RISC-V体系结构也提供32个浮点数通用寄存器，分别是f0-f31寄存器

------

RISC-V的通用寄存器通常具有别名和特殊用途，在书写汇编指令时可以直接使用别名。

- x0寄存器别名zero。寄存器的内容为0，可以用作源寄存器也可以作为目标寄存器
- x1寄存器别名ra，链接寄存器，用于保存函数返回地址
- x2寄存器别名sp，栈指针寄存器，指向栈的地址
- x3寄存器别名gp，全局寄存器，用于链接器松弛优化
- x4
- x5-x7,x28-x31寄存器为临时寄存器，它们的别名分别是t0~t6
- x8-x9以及x18-x27寄存器的别名分别是s0~s11
- x10-x17寄存器的别名分别为a0-a7，在函数调用时传递参数和返回值

### 系统寄存器

除了通用寄存器，RISC-V体系结构还定义了很多系统控制和状态寄存器（CSR），RISC-V体系支持如下3类系统寄存器：

- M模式的系统寄存器
  - mscratch寄存器：专门给M模式使用的临时寄存器
- S模式的系统寄存器
- U模式的系统寄存器

程序可以通过CSR指令来访问系统寄存器，不同情况下进入系统会对应不同的特权级别，起到保护系统的作用。在高级别的特权级别下可以访问低级别的CSR

## RISC-V基础指令集

### 无条件跳转指令

| 指令 | 指令格式            | 说明                                                         |
| ---- | ------------------- | ------------------------------------------------------------ |
| jal  | jal rd,offset       | 跳转到数值为PC+offset的地址，然后把返回地址(PC+4)保存到rd寄存器中<br />offset是21位有符号数 |
| jalr | jalr rd,offset(rs1) | 跳转到rs1+offset的地址处继续执行，然后把(PC+4)保存到rd寄存器中<br />offset是12位有符号数 |
|      |                     |                                                              |

#### 无条件跳转伪指令

| 伪指令    | 指令组合                                                     | 说明                                    |
| --------- | ------------------------------------------------------------ | --------------------------------------- |
| j label   | jal x0,offset                                                | 跳转到label处，不带返回地址             |
| jal label | jal ra,offset                                                | 跳转到label处，返回地址存储在ra寄存器中 |
| ret       | jalr x0,0(ra)                                                | 从ra寄存器中获得返回地址，并返回        |
| call func | auipc ra,offset[31:12]+offset[11]<br />jalr ra,offset[11:0] (ra) | 跳到func处执行，返回地址保存到ra        |





### 条件跳转指令

| 指令 | 指令格式          | 说明                          |
| ---- | ----------------- | ----------------------------- |
| beq  | beq rs1,rs2,label | 如果rs1==rs2，则跳转到label处 |
|      |                   |                               |

#### 条件跳转伪指令

| 伪指令        | 指令组合        | 判断条件 |
| ------------- | --------------- | -------- |
| beqz rs,label | beq rs,x0,label | rs==0    |
|               |                 |          |

### CSR指令

CSR指令用于访问系统寄存器：

| CSR指令 | 指令格式         | 说明                             |
| ------- | ---------------- | -------------------------------- |
| csrrw   | csrrw rd,csr,rs1 | csr中的值写入rd，rs1的值写入csr  |
| csrrs   | csrrs rd,csr,rs1 | csr中的值写入rd，然后和rs1按位或 |
|         |                  |                                  |

#### CSR伪指令

| 伪指令      | 指令组合        | 说明        |
| ----------- | --------------- | ----------- |
| csrr rd,csr | csrrs rd,csr,x0 | 读取csr到rd |
| csrw csr,rs | csrrw x0,csr,rs | rs写入csr   |
|             |                 |             |

## RISC-V的函数调用规范和栈

函数调用规范，有如下规则：

- 函数的前8个参数使用a0-a7寄存器传递，如果函数参数多于8个，后面的参数使用栈传递。
- 如果传递的参数小于寄存器宽度（64位），那么会符号扩展到64位。
- 函数返回参数保存到a0和a1寄存器。
- 函数的返回地址保存在ra寄存器中。
- 如果子函数里使用s0~s11寄存器，那么应该先将这些寄存器的值保存到栈中，用完再从栈中恢复
- 栈从高向低地址增长，sp寄存器在进入函数时要对齐到16字节的边界上。传递给栈的第一个参数位于sp寄存器偏移量0处。

